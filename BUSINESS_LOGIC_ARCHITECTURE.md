# BUSINESS LOGIC & ARCHITECTURE ANALYSIS

## üéØ –û–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

**OpenAI CLI 2** - —ç—Ç–æ –º–Ω–æ–≥–æ–ø—Ä–æ–≤–∞–π–¥–µ—Ä–Ω–æ–µ CLI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å AI –º–æ–¥–µ–ª—è–º–∏ (OpenAI, DeepSeek, Anthropic). –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è - –ø–µ—Ä–µ–≤–æ–¥—ã –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—ã –∏–∑ SQLite –ë–î.

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —Å—Ö–µ–º–∞

```
‚îå‚îÄ bin/app.js (Simple Bootstrapper) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  AIApplication extends Application                            ‚îÇ
‚îÇ  ‚îå‚îÄ –û–°–ù–û–í–ù–´–ï –ö–û–ú–ü–û–ù–ï–ù–¢–´: ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ stateManager: provider, models, contextHistory       ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ serviceManager: —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–µ—Ä–≤–∏—Å–æ–≤     ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ applicationLoop: UI layer + main loop + ESC          ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ router: routing decisions + execution                ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ CLEAN ARCHITECTURE FLOW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                                                              ‚îÇ
‚îÇ  User Input                                                  ‚îÇ
‚îÇ      ‚Üì                                                       ‚îÇ
‚îÇ  ApplicationLoop (core/ApplicationLoop.js)                  ‚îÇ
‚îÇ  ‚Ä¢ Main loop (while + readline.question)                    ‚îÇ
‚îÇ  ‚Ä¢ ESC handling (keypress ‚Üí AbortController.abort)          ‚îÇ
‚îÇ  ‚Ä¢ UI methods (writeOutput, colors, spinner coordination)   ‚îÇ
‚îÇ      ‚Üì                                                       ‚îÇ
‚îÇ  Router (core/Router.js)                                    ‚îÇ
‚îÇ  ‚Ä¢ router.routeAndProcess(input, applicationLoop)           ‚îÇ
‚îÇ  ‚Ä¢ Decision making + direct execution                       ‚îÇ
‚îÇ  ‚Ä¢ switch(commandType) ‚Üí Handler.handle()                   ‚îÇ
‚îÇ      ‚Üì                                                       ‚îÇ
‚îÇ  ‚îå‚îÄ SystemCommandHandler ‚îÄ‚îê  ‚îå‚îÄ CommandHandler ‚îÄ‚îÄ‚îê         ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ help, exit, provider ‚îÇ  ‚îÇ ‚Ä¢ Single commands  ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ model, cmd commands  ‚îÇ  ‚îÇ ‚Ä¢ Cache logic      ‚îÇ         ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ ‚Ä¢ ChatRequest call ‚îÇ         ‚îÇ
‚îÇ                               ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ
‚îÇ                                      ‚Üì                       ‚îÇ
‚îÇ                               ChatRequest                    ‚îÇ
‚îÇ                               ‚Ä¢ Final AI requests           ‚îÇ
‚îÇ                               ‚Ä¢ Unified spinner + ESC       ‚îÇ
‚îÇ                                      ‚Üì                       ‚îÇ
‚îÇ                               Result ‚Üí ApplicationLoop      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üìä –°–∏—Å—Ç–µ–º–∞ –∫–æ–º–∞–Ω–¥ (SQLite-based)

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–º–∞–Ω–¥ –≤ –ë–î:
```sql
CREATE TABLE commands (
  id TEXT PRIMARY KEY,           -- ENGLISH, RUSSIAN, HSK, etc.
  key TEXT NOT NULL,            -- JSON array: ["aa", "–∞–∞"]
  description TEXT NOT NULL,    -- "translate into English"
  instruction TEXT NOT NULL,    -- "please provide multiple English..."
  models TEXT DEFAULT NULL,     -- JSON array –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π
  is_cached BOOLEAN DEFAULT true, -- Per-command cache control (true=enabled, false=disabled)
  created_at INTEGER,
  updated_at INTEGER
)
```

### –ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã:
- **aa/–∞–∞** ‚Üí ENGLISH: –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–µ—Ä–µ–≤–æ–¥–∞ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π
- **cc/—Å—Å** ‚Üí CHINESE: –ø–µ—Ä–µ–≤–æ–¥ –Ω–∞ –∫–∏—Ç–∞–π—Å–∫–∏–π
- **rr** ‚Üí RUSSIAN: –ø–µ—Ä–µ–≤–æ–¥ –Ω–∞ —Ä—É—Å—Å–∫–∏–π
- **hsk** ‚Üí HSK: –ø–µ—Ä–µ–≤–æ–¥ –Ω–∞ Eng+Ru+Pinyin –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è –∫–∏—Ç–∞–π—Å–∫–æ–≥–æ
- **hskss** ‚Üí HSK_SS: —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –Ω–∞ –∫–∏—Ç–∞–π—Å–∫–æ–º + –ø–µ—Ä–µ–≤–æ–¥
- **gg** ‚Üí GRAMMAR: –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä–∞–º–º–∞—Ç–∏–∫–∏
- **pp/–ø–ø** ‚Üí PINYIN: —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –ø–∏–Ω—å–∏–Ω—å
- **tr** ‚Üí TRANSCRIPTION: –∞–Ω–≥–ª–∏–π—Å–∫–∞—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–∞–º–∏:
- **cmd/–∫–º–¥** ‚Üí CommandEditor –º–µ–Ω—é –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥
- –ö–æ–º–∞–Ω–¥—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ `/config/commands.db` (SQLite)
- –ú–∏–≥—Ä–∞—Ü–∏—è –∏–∑ `config/instructions.js` –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
- **Per-command cache control** - –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º —á–µ—Ä–µ–∑ CommandEditor:
  - Cache enabled/disabled –æ–ø—Ü–∏—è –≤ field selection menu
  - –ö–æ–º–∞–Ω–¥—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–æ–∑–¥–∞—é—Ç—Å—è —Å –≤–∫–ª—é—á–µ–Ω–Ω—ã–º –∫–µ—à–µ–º
  - –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–∫–ª—é—á–∏—Ç—å/–æ—Ç–∫–ª—é—á–∏—Ç—å –∫–µ—à –¥–ª—è –ª—é–±–æ–π –∫–æ–º–∞–Ω–¥—ã (–Ω–µ —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–≤–æ–¥–æ–≤)

## üé® –ú—É–ª—å—Ç–∏–º–æ–¥–µ–ª—å–Ω—ã–π –≤—ã–≤–æ–¥ (–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç)

### –ö–æ–º–∞–Ω–¥—ã —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –º–æ–¥–µ–ª—è–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `rr` —Å 2 –º–æ–¥–µ–ª—è–º–∏):
```
> rr Would you like to update?
[Handler: rr]

DeepSeek (deepseek-chat):
–ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ —Ä—É—Å—Å–∫–∏–π:
*–•–æ—Ç–∏—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å?*

–ò–¥–∏–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è / —É—Å—Ç–æ–π—á–∏–≤—ã–µ —Å–ª–æ–≤–æ—Å–æ—á–µ—Ç–∞–Ω–∏—è:
1. "Would you like to..." ‚Äì –≤–µ–∂–ª–∏–≤–∞—è —Ñ–æ—Ä–º–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏–ª–∏ –≤–æ–ø—Ä–æ—Å–∞ (*—Ö–æ—Ç–µ–ª–∏ –±—ã –≤—ã...*).
   - –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è: /w äd ju la…™k tu/
   - –ê–Ω–∞–ª–æ–≥ –≤ —Ä—É—Å—Å–∫–æ–º: *"–ù–µ —Ö–æ—Ç–∏—Ç–µ –ª–∏...?"*, *"–í–∞–º –Ω–µ —Ö–æ—á–µ—Ç—Å—è...?"* (–º–µ–Ω–µ–µ –±—É–∫–≤–∞–ª—å–Ω—ã–π, –Ω–æ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç).

*(–¢–µ–∫—Å—Ç –∫–æ—Ä–æ—Ç–∫–∏–π, –ø–æ—ç—Ç–æ–º—É –≤—ã–¥–µ–ª–µ–Ω–æ —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ.)*
‚úì 11.4s

OpenAI (gpt-5-mini):
–ü–µ—Ä–µ–≤–æ–¥:
- ¬´–•–æ—Ç–∏—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å?¬ª (–≤–∞—Ä–∏–∞–Ω—Ç –±–æ–ª–µ–µ –≤–µ–∂–ª–∏–≤—ã–π: ¬´–í—ã —Ö–æ—Ç–µ–ª–∏ –±—ã –æ–±–Ω–æ–≤–∏—Ç—å?¬ª)

–ò–¥–∏–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ:
- "Would you like to..." ‚Äî —É—Å—Ç–æ–π—á–∏–≤–æ–µ –≤–µ–∂–ª–∏–≤–æ–µ –æ–±–æ—Ä–æ—Ç–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏–ª–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è —á—Ç–æ‚Äë–ª–∏–±–æ —Å–¥–µ–ª–∞—Ç—å/–ø–æ–ª—É—á–∏—Ç—å. –ü–µ—Ä–µ–≤–æ–¥: ¬´–•–æ—Ç–∏—Ç–µ...¬ª, ¬´–í—ã —Ö–æ—Ç–µ–ª–∏ –±—ã...¬ª.
  –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è (—Ä–∞–∑–≥–æ–≤–æ—Ä–Ω–∞—è/—Å–≤–æ–±–æ–¥–Ω–∞—è): /w äd j…ô la…™k t…ô/
  –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è (—á–∏—Å—Ç–∞—è —Ñ–æ—Ä–º–∞): /w äd juÀê la…™k tuÀê/

–û—Ç–¥–µ–ª—å–Ω–æ —Å–ª–æ–≤–æ:
- "update" ‚Äî –≥–ª–∞–≥–æ–ª ¬´–æ–±–Ω–æ–≤–∏—Ç—å¬ª.
  –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è: / åpÀàde…™t/

[2/2 models responded in 12.8s]
```

**–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞:**
- `[Handler: rr]` - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–∞–∫–∞—è –∫–æ–º–∞–Ω–¥–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
- –û—Ç–¥–µ–ª—å–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –º–æ–¥–µ–ª–∏: `DeepSeek (deepseek-chat):` –∏ `OpenAI (gpt-5-mini):`
- Timing –¥–ª—è –∫–∞–∂–¥–æ–π –º–æ–¥–µ–ª–∏: `‚úì 11.4s`
- –§–∏–Ω–∞–ª—å–Ω–∞—è —Å–≤–æ–¥–∫–∞: `[2/2 models responded in 12.8s]`
- –†–µ–∞–ª—Ç–∞–π–º streaming - –æ—Ç–≤–µ—Ç—ã –ø–æ—è–≤–ª—è—é—Ç—Å—è –ø–æ –º–µ—Ä–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

## üèóÔ∏è –ü–†–ê–í–ò–õ–¨–ù–û–ï –†–ê–ó–î–ï–õ–ï–ù–ò–ï –û–¢–í–ï–¢–°–¢–í–ï–ù–ù–û–°–¢–ò

### –ü—Ä–∏–Ω—Ü–∏–ø—ã –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:

#### –ö–∞–∂–¥—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –û–î–ù–£ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:

- **`InputProcessingService`** - Single Source of Truth –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–≤–æ–¥–∞:
  - –ü–∞—Ä—Å–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –≤–≤–æ–¥ –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ñ–ª–∞–≥–∏
  - –ò—â–µ—Ç –∫–æ–º–∞–Ω–¥—ã –≤ SQLite –ë–î —á–µ—Ä–µ–∑ DatabaseCommandService
  - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç commandData
  - –ù–ï –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º, —Å—Ç—Ä–∏–º–∏–Ω–≥–æ–º, AI –∑–∞–ø—Ä–æ—Å–∞–º–∏

- **`Router`** (–±—ã–ª–æ RequestRouter) - –¢–û–õ–¨–ö–û routing decisions:
  - –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –∫–æ–º–∞–Ω–¥—ã –∏ routing target
  - –ü–µ—Ä–µ–¥–∞–µ—Ç –ø–æ–ª–Ω—ã–π commandData –æ–±—ä–µ–∫—Ç —Å–æ –≤—Å–µ–º–∏ –¥–∞–Ω–Ω—ã–º–∏
  - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: `{success, routingTarget, commandData}`
  - –ù–ï –≤—ã–ø–æ–ª–Ω—è–µ—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É, —Ç–æ–ª—å–∫–æ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ä–µ—à–µ–Ω–∏—è

- **`CommandHandler`** (–Ω–æ–≤—ã–π) - –æ–±—Ä–∞–±–æ—Ç–∫–∞ single –∫–æ–º–∞–Ω–¥:
  - –ü–æ–ª—É—á–∞–µ—Ç commandData –æ—Ç Router
  - –£–ø—Ä–∞–≤–ª—è–µ—Ç –∫–µ—à –ª–æ–≥–∏–∫–æ–π (–ø—Ä–æ–≤–µ—Ä–∫–∞ isCached && isForced)
  - –î–µ–ª–µ–≥–∏—Ä—É–µ—Ç –≤ CacheHandler –∏–ª–∏ ChatRequest
  - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –∫–µ—à –µ—Å–ª–∏ isCached=true

- **`MultiCommandHandler`** (–Ω–æ–≤—ã–π) - –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è multi-model:
  - –ö–æ–º–ø–æ–∑–∏—Ü–∏—è —á–µ—Ä–µ–∑ CommandHandler instances
  - LEADERBOARD —Å–∏—Å—Ç–µ–º–∞ - –≤—ã–≤–æ–¥ –ø–æ —Å–∫–æ—Ä–æ—Å—Ç–∏ –æ—Ç–≤–µ—Ç–∞
  - Mixed —Ä–µ–∂–∏–º (–∫–µ—à + live –∑–∞–ø—Ä–æ—Å—ã)
  - –ê–≥—Ä–µ–≥–∞—Ü–∏—è –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

- **`CacheHandler`** (–±—ã–ª–æ CacheManager) - —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–µ—à:
  - –ù–û–í–ê–Ø —Å—Ç—Ä—É–∫—Ç—É—Ä–∞: –∫–ª—é—á –ø–æ userInput
  - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ commandId + model + provider
  - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π: get/store
  - –ù–ï –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ä–µ—à–µ–Ω–∏—è, –ø–æ–ª—É—á–∞–µ—Ç –≥–æ—Ç–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏

- **`ChatRequest`** (–±—ã–ª–æ AIProcessor) - –¢–û–õ–¨–ö–û —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ AI –∑–∞–ø—Ä–æ—Å—ã:
  - –ü–æ–ª—É—á–∞–µ—Ç: `content` (–≥–æ—Ç–æ–≤–∞—è LLM –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è) + `model`
  - –£–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Ç—Ä–∏–º–∏–Ω–≥–æ–º –∏ AbortController
  - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: –æ—Ç–≤–µ—Ç –æ—Ç AI
  - –ù–ï –ø–∞—Ä—Å–∏—Ç –∫–æ–º–∞–Ω–¥—ã, –ù–ï —É–ø—Ä–∞–≤–ª—è–µ—Ç –∫–µ—à–µ–º

- **`StreamHandler`** - —Å—Ç—Ä–∏–º–∏–Ω–≥ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
  - –ü–æ–ª—É—á–∞–µ—Ç –≥–æ—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å—Ç—Ä–∏–º–∏–Ω–≥–∞
  - –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –≤—ã–≤–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
  - –ù–ï –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ä–µ—à–µ–Ω–∏—è –æ –ª–æ–≥–∏–∫–µ

### ‚ùå –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ï –ù–ê–†–£–®–ï–ù–ò–Ø (–∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø—Ä–∞–≤–ª—è–µ–º):

#### AIProcessor –¥–µ–ª–∞–ª –í–°–ï (–º–æ–Ω–æ–ª–∏—Ç):
- ‚ùå –ü–∞—Ä—Å–∏–ª –∫–æ–º–∞–Ω–¥—ã (–¥–æ–ª–∂–µ–Ω CommandProcessingService)
- ‚ùå –ü—Ä–∏–Ω–∏–º–∞–ª —Ä–µ—à–µ–Ω–∏—è –æ –∫–µ—à–µ (–¥–æ–ª–∂–µ–Ω CacheManager)
- ‚ùå –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–ª –≤—ã–≤–æ–¥ (–¥–æ–ª–∂–µ–Ω StreamHandler)
- ‚ùå –°–æ–∑–¥–∞–≤–∞–ª –∫–æ–º–∞–Ω–¥—ã (–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å CommandProcessingService)
- ‚ùå Observer –º–µ—Ç—Ä–∏–∫–∏ (–Ω–µ –µ–≥–æ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å)

#### –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏:
- ‚ùå 3 –º–µ—Å—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥: CommandProcessingService, RequestRouter, AIProcessor
- ‚ùå –û–±—Ä–∞–±–æ—Ç–∫–∞ $$ –≤ 3 –º–µ—Å—Ç–∞—Ö –≤–º–µ—Å—Ç–æ –æ–¥–Ω–æ–≥–æ InputProcessingService
- ‚ùå –ü—Ä–æ–≤–µ—Ä–∫–∏ force flags –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –≤ InputProcessingService)
- ‚ùå –ü—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∏–ø–∞ –∫–æ–º–∞–Ω–¥ –≤ cache handlers (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –≤ RequestRouter)

#### –ê–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω—ã –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è:
- ‚ùå **"–£–º–Ω—ã–µ" –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ CacheManager**: `const isMultiModel = command?.models && Array.isArray(command.models)`
- ‚ùå **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ force flags**: –∫–∞–∂–¥—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å–∞–º –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `--force`
- ‚ùå **–ü—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏–π –≤ handlers**: cache/stream handlers –Ω–µ –¥–æ–ª–∂–Ω—ã —Ä–µ—à–∞—Ç—å, —á—Ç–æ –¥–µ–ª–∞—Ç—å
- ‚ùå **–°–ª–æ–∂–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã –≤–æ–∑–≤—Ä–∞—Ç–æ–≤**: `{shouldUse, shouldStore, reason}` –≤–º–µ—Å—Ç–æ –ø—Ä–æ—Å—Ç–æ–≥–æ boolean

### ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê (ApplicationLoop ‚Üí Router):

```
User Input ‚Üí ApplicationLoop.startMainLoop()
                    ‚Üì
        router.routeAndProcess(input, applicationLoop)
                    ‚Üì
            Router internal logic:
                    ‚Üì
     ‚îå‚îÄ SYSTEM commands ‚Üí SystemCommandHandler
     ‚îÇ   ‚îú‚îÄ help ‚Üí HelpCommand
     ‚îÇ   ‚îú‚îÄ exit ‚Üí ExitCommand.execute() ‚Üí applicationLoop.exitApp()
     ‚îÇ   ‚îú‚îÄ provider ‚Üí ProviderCommand
     ‚îÇ   ‚îú‚îÄ model ‚Üí ModelCommand
     ‚îÇ   ‚îî‚îÄ cmd ‚Üí CommandEditorCommand
     ‚îÇ
     ‚îú‚îÄ INSTRUCTION commands ‚Üí CommandHandler
     ‚îÇ   ‚îú‚îÄ Create commandData from DatabaseCommandService
     ‚îÇ   ‚îú‚îÄ Check cache: isCached && !isForced
     ‚îÇ   ‚îú‚îÄ Cache hit ‚Üí return cached result
     ‚îÇ   ‚îú‚îÄ Cache miss ‚Üí ChatRequest with prepared content
     ‚îÇ   ‚îî‚îÄ Store result if isCached=true
     ‚îÇ
     ‚îî‚îÄ CHAT (not found) ‚Üí ChatRequest (direct)
         ‚îî‚îÄ commandData: {content: input, isForced: false}

           ‚Üì (all paths)
    outputHandler methods (writeOutput, writeError, etc.)
```

**Key changes:**
- **No RequestProcessor/CommandDispatcher** - YAGNI principle
- **Router handles both decisions AND execution** - Single responsibility
- **ApplicationLoop focuses on UI concerns** - Clean separation
- **Unified ESC handling** through AbortController everywhere

### üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ commandData (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç):

```javascript
{
  success: true/false,              // –ö–æ–º–∞–Ω–¥–∞ –Ω–∞–π–¥–µ–Ω–∞ –∏ –≤–∞–ª–∏–¥–Ω–∞
  content: "instruction: userInput", // –ì–æ—Ç–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è LLM
  userInput: "–±–∏—Ç–∫–æ–∏–Ω",             // –ß–∏—Å—Ç—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –≤–≤–æ–¥
  instruction: "–û–±—ä—è—Å–Ω–∏ —á—Ç–æ —ç—Ç–æ?",  // –ò–∑ –ë–î instruction field
  id: "WTF_COMMAND",                // ID –∫–æ–º–∞–Ω–¥—ã –∏–∑ –ë–î
  models: ["gpt-5-mini"],           // –ú–∞—Å—Å–∏–≤ –º–æ–¥–µ–ª–µ–π –∏–∑ –ë–î –∏–ª–∏ default
  isCached: true,                   // –ò–∑ –ë–î –ø–æ–ª–µ is_cached
  isForced: false                   // --force —Ñ–ª–∞–≥ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
}
```

### üéØ –ù–û–í–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê: ApplicationLoop ‚Üí Router

#### Clean Flow (–±–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–ª–æ–µ–≤):
```
User Input 
  ‚Üì
ApplicationLoop.startMainLoop() 
  ‚Üì  
router.routeAndProcess(input, applicationLoop)
  ‚Üì
Router.routeAndProcess() internal:
  - detectCommandType(input)
  - createCommandData(input) 
  - switch(commandType) ‚Üí Handler.handle(commandData, applicationLoop)
  ‚Üì
Result ‚Üí applicationLoop.writeOutput()
```

#### –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏:

**ApplicationLoop** (implements core/ApplicationLoop.js):
- Main application loop (`while(true)` + `readline.question()`)
- ESC handling through AbortController (handleEscapeKey ‚Üí controller.abort())
- Graceful shutdown with 3-phase exitApp() method:
  - Phase 1: stopUserInput() - closes readline interface
  - Phase 2: cancelActiveOperations() - aborts LLM requests, clears timers
  - Phase 3: finalCleanup() - shows cursor, goodbye message, process.exit(0)
- UI layer compatibility methods (writeOutput, writeError, writeWarning, writeInfo)
- State management integration through StateManager
- Spinner coordination and creation (createSpinner, showInitializationSpinner)

**Router** (existing, enhanced):
- Pure decision engine + direct execution
- Analyzes input, creates commandData, executes handlers
- Internal method: `routeAndProcess(input, applicationLoop)`
- No legacy routingTarget approach

**SystemCommandHandler** (new):
- Handles system commands (help, exit, provider, model, cmd)
- Replaces scattered system command logic

**CommandHandler** (existing):
- Handles single instruction commands from database
- Cache logic management (isCached && isForced checks)
- Delegates to ChatRequest for AI requests

**ChatRequest** (existing):
- Final AI request processing
- Unified spinner + ESC handling through AbortController
- Streaming response management

## üéØ Multi-command –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (–ö–æ–º–ø–æ–∑–∏—Ü–∏—è vs –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ)

### ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–º–ø–æ–∑–∏—Ü–∏—è:
```javascript
// MultiCommandHandler –∏—Å–ø–æ–ª—å–∑—É–µ—Ç CommandHandler —á–µ—Ä–µ–∑ –∫–æ–º–ø–æ–∑–∏—Ü–∏—é
class MultiCommandHandler {
  constructor() {
    this.commandHandler = new CommandHandler() // –ö–æ–º–ø–æ–∑–∏—Ü–∏—è!
    this.cacheHandler = new CacheHandler()
  }

  async execute(commandData) {
    const { models, userInput, id, isCached, isForced } = commandData
    
    // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∫–æ–º–ø–æ–∑–∏—Ü–∏—é
    const promises = models.map(async (model) => {
      // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–µ—à –¥–ª—è –∫–∞–∂–¥–æ–π –º–æ–¥–µ–ª–∏
      if (!isForced && isCached) {
        const cached = await this.cacheHandler.get(userInput, id, model)
        if (cached) return { ...cached, fromCache: true }
      }
      
      // Live –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ CommandHandler
      const singleCommandData = { ...commandData, models: [model] }
      return await this.commandHandler.execute(singleCommandData)
    })
    
    // LEADERBOARD - –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø–æ –º–µ—Ä–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è
    const results = []
    for await (const result of Promise.allSettled(promises)) {
      if (result.status === 'fulfilled') {
        results.push(result.value)
        this.streamResult(result.value) // –°—Ä–∞–∑—É –Ω–∞—á–∏–Ω–∞–µ–º –æ—Ç—Ä–∏—Å–æ–≤–∫—É
      }
    }
    
    // Leaderboard —Å–∏—Å—Ç–µ–º–∞ + —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    return this.aggregateAndFormat(results)
  }
}
```

### –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ Multi-command:
1. **Orchestration** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º
2. **Leaderboard** - –ø–æ—Ä—è–¥–æ–∫ –≤—ã–≤–æ–¥–∞ –ø–æ —Å–∫–æ—Ä–æ—Å—Ç–∏ –æ—Ç–≤–µ—Ç–∞ 
3. **Aggregation** - —Å–±–æ—Ä –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
4. **Mixed —Ä–µ–∂–∏–º** - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ –∫–µ—à–∞ (–∫–µ—à + live)

### ‚ùå –ß—Ç–æ –ù–ï –¥–µ–ª–∞–µ—Ç Multi-command:
- –ù–ï –¥—É–±–ª–∏—Ä—É–µ—Ç Single command –ª–æ–≥–∏–∫—É
- –ù–ï –¥–µ–ª–∞–µ—Ç –ø—Ä—è–º—ã–µ AI –∑–∞–ø—Ä–æ—Å—ã
- –ù–ï –ø–∞—Ä—Å–∏—Ç –∫–æ–º–∞–Ω–¥—ã
- –ù–ï –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ä–µ—à–µ–Ω–∏—è –æ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–∏

## üéØ –ë–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞ –º—É–ª—å—Ç–∏–º–æ–¥–µ–ª—å–Ω—ã—Ö –∫–æ–º–∞–Ω–¥

### –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –º—É–ª—å—Ç–∏–º–æ–¥–µ–ª—å–Ω—ã—Ö –∫–æ–º–∞–Ω–¥:
- ‚úÖ **–ì–∏–±–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è** - –∫–µ—à –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç—Å—è –ø–æ–ª–µ–º `is_cached` –≤ –ë–î
- **–ò–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–µ—à–∞** - –∫–∞–∂–¥—ã–π `userInput` —Å–æ–¥–µ—Ä–∂–∏—Ç –º–∞—Å—Å–∏–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ—Ç —Ä–∞–∑–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ –∏ –º–æ–¥–µ–ª–µ–π
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∫–æ–º–∞–Ω–¥** - `rr hello` –∏ `kg hello` –ù–ï –ø–µ—Ä–µ—Å–µ–∫–∞—é—Ç—Å—è, –∫–∞–∂–¥–∞—è –∫–æ–º–∞–Ω–¥–∞ –∏–º–µ–µ—Ç —Å–≤–æ–π `commandId`
- **Mixed —Ä–µ–∂–∏–º** - —á–∞—Å—Ç—å –æ—Ç–≤–µ—Ç–æ–≤ –∏–∑ –∫–µ—à–∞ (–º–≥–Ω–æ–≤–µ–Ω–Ω–æ), —á–∞—Å—Ç—å live –∑–∞–ø—Ä–æ—Å–æ–≤ (—Å—Ç—Ä–∏–º–∏–Ω–≥)
- **Force flags** (`-f`, `--force`) –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç –∫–µ—à
- **Per-command control**: –ª—é–±–∞—è –∫–æ–º–∞–Ω–¥–∞ –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º

#### –ù–û–í–ê–Ø —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –∫–µ—à–µ (–∫–ª—é—á = userInput):
```js
// –ö–ª—é—á –∫–µ—à–∞ - —á–∏—Å—Ç—ã–π userInput –ë–ï–ó –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
"–±–∏—Ç–∫–æ–∏–Ω": {
  userInput: "–±–∏—Ç–∫–æ–∏–Ω",
  results: [
    {
      commandId: "WTF_COMMAND",  // –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º
      provider: "openai", 
      model: "gpt-5-mini",
      response: "Bitcoin - —ç—Ç–æ –¥–µ—Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞...",
      timestamp: 1642543200000
    },
    {
      commandId: "EXPLAIN",      // –î—Ä—É–≥–∞—è –∫–æ–º–∞–Ω–¥–∞, —Ç–æ—Ç –∂–µ userInput
      provider: "deepseek",
      model: "deepseek-chat", 
      response: "–ë–∏—Ç–∫–æ–∏–Ω –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π...",
      timestamp: 1642543210000
    }
  ]
}

// –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: –∫–æ–º–∞–Ω–¥—ã "wtf –±–∏—Ç–∫–æ–∏–Ω" –∏ "explain –±–∏—Ç–∫–æ–∏–Ω" 
// –ù–ï –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç –±–ª–∞–≥–æ–¥–∞—Ä—è —Ä–∞–∑–Ω—ã–º commandId
```

#### Mixed —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã:
```bash
> kg hello world
<from cache>
[DeepSeek deepseek-chat]  
—Å–∞–ª–∞–º –¥“Ø–π–Ω”©

[Anthropic claude-3-5-sonnet] ‚Üê live –∑–∞–ø—Ä–æ—Å + —Å—Ç—Ä–∏–º–∏–Ω–≥
—Å–∞–ª–∞–º –¥“Ø–π–Ω”©! ...—Å—Ç—Ä–∏–º–∏–Ω–≥...

[2/2 models responded - 1 from cache, 1 live]
```

### –°—Ç—Ä–∏–º–∏–Ω–≥ –º—É–ª—å—Ç–∏–º–æ–¥–µ–ª—å–Ω—ã—Ö –∫–æ–º–∞–Ω–¥:
- ‚úÖ **Leaderboard system** - –º–æ–¥–µ–ª–∏ –≤—ã–≤–æ–¥—è—Ç—Å—è –≤ –ø–æ—Ä—è–¥–∫–µ "–∫—Ç–æ –±—ã—Å—Ç—Ä–µ–µ –æ—Ç–≤–µ—Ç–∏–ª"
- ‚úÖ **Real-time —Å—Ç—Ä–∏–º–∏–Ω–≥** –æ—Ç —Å–∞–º–æ–π –±—ã—Å—Ç—Ä–æ–π –º–æ–¥–µ–ª–∏ (–ø–µ—Ä–≤–æ–π –≤ leaderboard)
- ‚úÖ **–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ**:
  - –ü–æ–∫–∞ –æ—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç—Å—è –ø–µ—Ä–≤–∞—è –º–æ–¥–µ–ª—å –ø–æ —á–∞–Ω–∫–∞–º, –≤—Ç–æ—Ä–∞—è –º–æ–∂–µ—Ç –ø–æ—á—Ç–∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è
  - –ï—Å–ª–∏ –≤—Ç–æ—Ä–∞—è –º–æ–¥–µ–ª—å –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ `done` ‚Üí –≤—ã–≤–æ–¥–∏—Ç—å –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å—Ä–∞–∑—É –ø–æ–ª–Ω–æ—Å—Ç—å—é
  - –ï—Å–ª–∏ –≤—Ç–æ—Ä–∞—è –º–æ–¥–µ–ª—å –ø–æ—á—Ç–∏ –≥–æ—Ç–æ–≤–∞ ‚Üí –≤—ã–≤–æ–¥–∏—Ç—å "—á—Ç–æ —É–∂–µ –ø—Ä–∏—à–ª–æ" —Å—Ä–∞–∑—É + –æ—Å—Ç–∞—Ç–∫–∏ –ø–æ —á–∞–Ω–∫–∞–º
- ‚úÖ **–í—Å–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏** –¥–æ–ª–∂–Ω—ã –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è
- ‚úÖ **–ó–∞–≥–æ–ª–æ–≤–∫–∏** —Å –∏–º–µ–Ω–∞–º–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ –∏ –º–æ–¥–µ–ª–µ–π –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –æ—Ç–≤–µ—Ç–æ–º
- ‚úÖ **–ü–æ—Ä—è–¥–æ–∫ –≤—ã–≤–æ–¥–∞** = —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ—Ä—è–¥–æ–∫ –ø–µ—Ä–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (leaderboard)

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤—ã–≤–æ–¥–∞:
```
> rr –∫–∞–∫ –¥–µ–ª–∞?
[Handler: rr]

DeepSeek (deepseek-chat):    ‚Üê –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø–µ—Ä–≤–æ–π (—Å–∞–º–æ–π –±—ã—Å—Ç—Ä–æ–π) –º–æ–¥–µ–ª–∏
[real-time streaming]        ‚Üê —Å—Ç—Ä–∏–º–∏–Ω–≥ –ø–æ —á–∞–Ω–∫–∞–º
‚úì 11.4s                     ‚Üê timing –ø–µ—Ä–≤–æ–π –º–æ–¥–µ–ª–∏

OpenAI (gpt-5-mini):        ‚Üê –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤—Ç–æ—Ä–æ–π –º–æ–¥–µ–ª–∏  
[–ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç —Å—Ä–∞–∑—É]        ‚Üê –µ—Å–ª–∏ done, –∏–ª–∏ —á–∞—Å—Ç–∏—á–Ω—ã–π + —Å—Ç—Ä–∏–º–∏–Ω–≥
[2/2 models responded in 12.8s] ‚Üê —Ñ–∏–Ω–∞–ª—å–Ω–∞—è —Å–≤–æ–¥–∫–∞
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ –º—É–ª—å—Ç–∏–º–æ–¥–µ–ª—å–Ω—ã—Ö –∫–æ–º–∞–Ω–¥–∞—Ö:
- ‚úÖ –ï—Å–ª–∏ –æ–¥–Ω–∞ –º–æ–¥–µ–ª—å –ø–∞–¥–∞–µ—Ç ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É + –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –æ—Å—Ç–∞–ª—å–Ω—ã–º–∏
- ‚úÖ –ï—Å–ª–∏ –≤—Å–µ –º–æ–¥–µ–ª–∏ –ø–∞–¥–∞—é—Ç ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å –æ–±—â—É—é –æ—à–∏–±–∫—É
- ‚úÖ Partial success ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å —É—Å–ø–µ—à–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã + –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö

## üéØ –¢–ï–†–ú–ò–ù–û–õ–û–ì–ò–Ø –ü–†–û–ï–ö–¢–ê (—Å—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è –≤—Å–µ–≥–æ –∫–æ–¥–∞)

### –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞:

- **`prompt`** - —Å—ã—Ä–∞—è —Å—Ç—Ä–æ–∫–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: `"aa –ø—Ä–∏–≤–µ—Ç –º–∏—Ä $$ -f"`
  - –°–æ–¥–µ—Ä–∂–∏—Ç: –∫–æ–º–∞–Ω–¥—É, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ç–µ–∫—Å—Ç, clipboard –º–∞—Ä–∫–µ—Ä—ã, —Ñ–ª–∞–≥–∏
  - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤: InputProcessingService

- **`instruction`** - —à–∞–±–ª–æ–Ω –∫–æ–º–∞–Ω–¥—ã –∏–∑ SQLite –ë–î: `"–ø–µ—Ä–µ–≤–µ–¥–∏ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫"`  
  - –•—Ä–∞–Ω–∏—Ç—Å—è –≤: `commands.instruction` –ø–æ–ª–µ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è: —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ content –¥–ª—è LLM

- **`userInput`** - –æ—á–∏—â–µ–Ω–Ω—ã–π –≤–≤–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: `"–ø—Ä–∏–≤–µ—Ç –º–∏—Ä clipboard_content"`
  - –ü–æ–ª—É—á–∞–µ—Ç—Å—è –∏–∑ prompt –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è: –∫–æ–º–∞–Ω–¥—ã, $$, —Ñ–ª–∞–≥–æ–≤
  - –ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç: —á–∏—Å—Ç—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏

- **`content`** - —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è LLM: `"–ø–µ—Ä–µ–≤–µ–¥–∏ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫: –ø—Ä–∏–≤–µ—Ç –º–∏—Ä clipboard_content"`
  - –§–æ—Ä–º—É–ª–∞: `instruction + ": " + userInput`
  - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤: AI –º–æ–¥–µ–ª–∏ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### –ü—Ä–∏–Ω—Ü–∏–ø—ã –Ω–µ–π–º–∏–Ω–≥–∞:
- ‚ùå `input`, `targetContent`, `fullInstruction`, `finalInput` - –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º
- ‚úÖ –¢–æ–ª—å–∫–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã: `prompt`, `instruction`, `userInput`, `content`

## üîÑ –ü–æ—Ç–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞

### 1. –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª (AIApplication.run):
–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–º —Ü–∏–∫–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞:
- –û–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (`prompt`)
- –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –∑–∞–ø—Ä–æ—Å–∞ (–∫–æ–º–∞–Ω–¥–∞ –∏–ª–∏ AI-–∑–∞–ø—Ä–æ—Å)
- –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–º—É –æ–±—Ä–∞–±–æ—Ç—á–∏–∫—É

### 2. –ü–æ—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–≤–æ–¥–∞ (Single Source of Truth):

```
1. User prompt: "wtf –±–∏—Ç–∫–æ–∏–Ω --force"
   ‚Üì
2. InputProcessingService.process()
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ñ–ª–∞–≥–∏: isForced = true
   - –£–±–∏—Ä–∞–µ—Ç —Ñ–ª–∞–≥–∏ –∏–∑ —Å—Ç—Ä–æ–∫–∏: "wtf –±–∏—Ç–∫–æ–∏–Ω"
   - –ù–∞—Ö–æ–¥–∏—Ç –∫–æ–º–∞–Ω–¥—É –≤ –ë–î: WTF_COMMAND
   ‚Üì
3. Router.routeRequest() 
   - –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –∏–∑ InputProcessingService
   - –§–æ—Ä–º–∏—Ä—É–µ—Ç commandData:
     {
       content: "–û–±—ä—è—Å–Ω–∏ —á—Ç–æ —ç—Ç–æ?: –±–∏—Ç–∫–æ–∏–Ω",
       userInput: "–±–∏—Ç–∫–æ–∏–Ω",
       instruction: "–û–±—ä—è—Å–Ω–∏ —á—Ç–æ —ç—Ç–æ?",
       id: "WTF_COMMAND",
       models: ["gpt-5-mini"],
       isCached: true,
       isForced: true
     }
   - –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç routingTarget: 'command_handler'
   ‚Üì  
4. CommandHandler
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç isForced=true ‚Üí –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –∫–µ—à
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ ChatRequest —Å –≥–æ—Ç–æ–≤—ã–º content
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –∫–µ—à (isCached=true)
```

### 3. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ:
- **$$** –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –≤ `InputProcessingService`
- **–í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã** –ø–æ–ª—É—á–∞—é—Ç —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- **–ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è** –æ–±—Ä–∞–±–æ—Ç–∫–∏ clipboard –º–∞—Ä–∫–µ—Ä–æ–≤

## üéØ –õ–æ–≥–∏–∫–∞ —Ä–æ—É—Ç–µ—Ä–∞ —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º

### –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π RequestRouter:

#### –ü–†–ê–í–ò–õ–¨–ù–û–ï –î–ï–†–ï–í–û –†–ï–®–ï–ù–ò–ô (—Å–æ–≥–ª–∞—Å–Ω–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ)

```
1. User Input ‚Üí InputProcessingService
   ‚îú‚îÄ Parse clipboard markers: $$ ‚Üí clipboard_content
   ‚îú‚îÄ Extract force flags: --force, -f 
   ‚îî‚îÄ Return: {userInput, forceFlags}
   
2. Router.routeRequest(userInput) + commandData
   ‚Üì
   2.1 CHECK SYSTEM COMMANDS FIRST (–ü–†–ò–û–†–ò–¢–ï–¢)
       ‚îú‚îÄ if (unifiedCommandManager.hasCommand(command)) 
       ‚îÇ   ‚îî‚îÄ Route to: SystemCommandHandler 
       ‚îÇ       ‚îú‚îÄ help ‚Üí HelpCommand
       ‚îÇ       ‚îú‚îÄ exit ‚Üí ExitCommand  
       ‚îÇ       ‚îú‚îÄ provider ‚Üí ProviderCommand
       ‚îÇ       ‚îú‚îÄ model ‚Üí ModelCommand
       ‚îÇ       ‚îî‚îÄ cmd ‚Üí CommandEditorCommand
       ‚Üì
   2.2 CHECK USER COMMANDS FROM DATABASE
       ‚îú‚îÄ DatabaseCommandService.findByKey(command)
       ‚îÇ   ‚îú‚îÄ Found ‚Üí analyze command.models.length
       ‚îÇ   ‚îÇ   ‚îú‚îÄ models.length === 0 ‚Üí SingleCommand (default model)
       ‚îÇ   ‚îÇ   ‚îú‚îÄ models.length === 1 ‚Üí SingleCommand (specific model) 
       ‚îÇ   ‚îÇ   ‚îî‚îÄ models.length > 1 ‚Üí MultiCommandHandler
       ‚îÇ   ‚îî‚îÄ Not found ‚Üí route to default LLM
       ‚Üì
   2.3 MULTICOMMAND COMPOSITION (NO DUPLICATION)
       ‚îî‚îÄ MultiCommandHandler composes N √ó CommandHandler instances
           ‚îú‚îÄ CommandHandler 1 ‚Üí model A
           ‚îú‚îÄ CommandHandler 2 ‚Üí model B  
           ‚îî‚îÄ Aggregate results + leaderboard + formatting
```

#### –¢–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—è –∏ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏:
- **SystemCommandHandler** - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã (help, exit, provider, model, cmd)
- **CommandHandler** (–Ω–æ–≤—ã–π) - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç single –∫–æ–º–∞–Ω–¥—ã –∏–∑ SQLite –ë–î —Å –∫–µ—à –ª–æ–≥–∏–∫–æ–π
- **MultiCommandHandler** (–Ω–æ–≤—ã–π) - –∫–æ–º–ø–æ–∑–∏—Ä—É–µ—Ç CommandHandler instances –¥–ª—è multi-model —Å leaderboard
- **CacheHandler** (–Ω–æ–≤—ã–π) - —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–µ—à —Å –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –ø–æ userInput
- **ChatRequest** - —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ AI –∑–∞–ø—Ä–æ—Å–æ–≤ (–±—ã–ª–æ AIProcessor)
- **DatabaseCommandService** - –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —Ç–æ—á–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ SQLite –ë–î –∫–æ–º–∞–Ω–¥

#### 1. –ö–æ–º–∞–Ω–¥–∞ –ù–ï –Ω–∞–π–¥–µ–Ω–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:
```
User input ‚Üí RequestRouter ‚Üí DatabaseCommandService.findByKey() ‚Üí null
‚Üí –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞–ø—Ä—è–º—É—é –≤ default LLM (–±–µ–∑ –∫—ç—à–∞)
```

#### 2. –ö–æ–º–∞–Ω–¥–∞ –Ω–∞–π–¥–µ–Ω–∞ ‚Üí –∞–Ω–∞–ª–∏–∑ models + isCached:

##### 2.1. –ü—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –º–æ–¥–µ–ª–µ–π (`command.models.length === 0`):
```js
if (command.isCached === true) {
  // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫—ç—à ‚Üí –µ—Å–ª–∏ –µ—Å—Ç—å –æ—Ç–≤–µ—Ç, –≤–µ—Ä–Ω—É—Ç—å –∏–∑ –∫—ç—à–∞
  // –ï—Å–ª–∏ –∫—ç—à–∞ –Ω–µ—Ç ‚Üí –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ default model + —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫—ç—à
} else {
  // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ default model –±–µ–∑ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
}
```

##### 2.2. –û–¥–Ω–∞ –º–æ–¥–µ–ª—å (`command.models.length === 1`):
```js
if (command.isCached === true) {
  // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫—ç—à ‚Üí –µ—Å–ª–∏ –µ—Å—Ç—å –æ—Ç–≤–µ—Ç, –≤–µ—Ä–Ω—É—Ç—å –∏–∑ –∫—ç—à–∞
  // –ï—Å–ª–∏ –∫—ç—à–∞ –Ω–µ—Ç ‚Üí –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —É–∫–∞–∑–∞–Ω–Ω—É—é –º–æ–¥–µ–ª—å + —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫—ç—à
} else {
  // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —É–∫–∞–∑–∞–Ω–Ω—É—é –º–æ–¥–µ–ª—å –±–µ–∑ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è  
}
```

##### 2.3. –ù–µ—Å–∫–æ–ª—å–∫–æ –º–æ–¥–µ–ª–µ–π (`command.models.length > 1`):
```js
if (command.isCached === true) {
  // –î–ª—è –∫–∞–∂–¥–æ–π –º–æ–¥–µ–ª–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫—ç—à:
  // - –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –µ—Å—Ç—å –≤ –∫—ç—à–µ ‚Üí –≤–∑—è—Ç—å –∏–∑ –∫—ç—à–∞
  // - –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç–∞ –Ω–µ—Ç ‚Üí –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å + —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫—ç—à
  // –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –æ—Ç–≤–µ—Ç—ã (–∏–∑ –∫—ç—à–∞ + –Ω–æ–≤—ã–µ)
} else {
  // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–æ –≤—Å–µ —É–∫–∞–∑–∞–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏ –±–µ–∑ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
}
```

### –ü—Ä–∏–Ω—Ü–∏–ø—ã –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è:

#### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏:
- **InputProcessingService**: –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ñ–ª–∞–≥–∏ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω—ã–π commandData
- **Router**: –¢–û–õ–¨–ö–û routing decisions, –ø–µ—Ä–µ–¥–∞–µ—Ç commandData –¥–∞–ª—å—à–µ
- **CommandHandler**: —É–ø—Ä–∞–≤–ª—è–µ—Ç –∫–µ—à –ª–æ–≥–∏–∫–æ–π –Ω–∞ –æ—Å–Ω–æ–≤–µ isCached + isForced
- **CacheHandler**: —Ç—É–ø–æ–π –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å —Å –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –ø–æ userInput
- **MultiCommandHandler**: –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è –∏ leaderboard –¥–ª—è multi-model
- **ChatRequest**: —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ AI –∑–∞–ø—Ä–æ—Å–æ–≤

#### –õ–æ–≥–∏–∫–∞ Force Flags:
- **`--force` –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –ß–¢–ï–ù–ò–ï –∫–µ—à–∞** ‚Üí –≤—Å–µ–≥–¥–∞ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç LLM
- **`--force` –ù–ï –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –ó–ê–ü–ò–°–¨ –∫–µ—à–∞** ‚Üí —Ä–µ–∑—É–ª—å—Ç–∞—Ç –°–û–•–†–ê–ù–Ø–ï–¢–°–Ø (–ø–µ—Ä–µ–∑–∞—Ç–∏—Ä–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã)
- **–ü—Ä–∏–º–µ—Ä**: `aa hello --force` ‚Üí –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å —á—Ç–µ–Ω–∏–µ –∫–µ—à–∞ ‚Üí –∑–∞–ø—Ä–æ—Å–∏—Ç—å LLM ‚Üí —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –∫–µ—à

#### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:
- **–ö–ª—é—á –∫—ç—à–∞**: `userInput` (—á–∏—Å—Ç—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –≤–≤–æ–¥ –ë–ï–ó –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∫–æ–º–∞–Ω–¥—ã)
- **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è**: –ø–æ `commandId + provider + model` –≤–Ω—É—Ç—Ä–∏ CacheManager
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –∫–æ–º–∞–Ω–¥—ã `rr hello` –∏ `kg hello` –ù–ï –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç (—Ä–∞–∑–Ω—ã–µ `commandId`)
- **Per-command control**: —á–µ—Ä–µ–∑ –ø–æ–ª–µ `is_cached` –≤ –ë–î (–ù–ï `cache_enabled`!)
- **–ë–µ–∑ TTL**: —á–∏—Å—Ç–∫–∞ –∫–µ—à–∞ —á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω—É—é –∫–æ–º–∞–Ω–¥—É, —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### Unified ESC Handling Architecture:

**Problem**: ESC –æ–±—Ä–∞–±–æ—Ç–∫–∞ –±—ã–ª–∞ —Ä–∞–∑–º–∞–∑–∞–Ω–∞ –ø–æ 3 –º–µ—Å—Ç–∞–º:
- CLIManager - keypress events
- StateObserver - —Å–æ–±—ã—Ç–∏–π–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞  
- Unified Spinner - AbortController

**Solution**: AbortController –∫–∞–∫ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º:
```javascript
// ApplicationLoop catches ESC
process.stdin.on('keypress', (str, key) => {
  if (key.name === 'escape') {
    const controller = stateManager.getCurrentRequestController()
    if (controller) {
      controller.abort() // –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —Ç–æ—á–∫–∞ –æ—Ç–º–µ–Ω—ã!
    }
  }
})

// –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–ª—É—à–∞—é—Ç AbortController.signal
// - Spinner: abortController.signal.addEventListener('abort')
// - ChatRequest: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç unified spinner —Å controller
// - StateObserver: –º–æ–∂–µ—Ç –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ abort events
```

### –ù–æ–≤—ã–π –ø–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö:
```
User Input ‚Üí ApplicationLoop (UI + ESC + main loop)
                    ‚Üì
        router.routeAndProcess(input, applicationLoop)
                    ‚Üì
            Router (decisions + execution):
                    ‚Üì
    ‚îå‚îÄ SystemCommandHandler ‚îÄ‚îê    ‚îå‚îÄ CommandHandler ‚îÄ‚îÄ‚îê
    ‚îÇ   ‚Ä¢ help, exit, etc.   ‚îÇ    ‚îÇ  ‚Ä¢ Single commands ‚îÇ
    ‚îÇ   ‚Ä¢ Direct execution   ‚îÇ    ‚îÇ  ‚Ä¢ Cache logic     ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ  ‚Ä¢ ChatRequest call‚îÇ
                                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚Üì
           applicationLoop.writeOutput(result)
```

### 2. –ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ (ApplicationLoop ‚Üí Router):

#### 2.1 ApplicationLoop - UI –∏ –≥–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª:
- Main application loop (`while(true)` + `readline.question()`)
- Low-level ESC handling —á–µ—Ä–µ–∑ AbortController
- UI layer (colors, writeOutput, writeError methods)
- Spinner coordination

#### 2.2 Router - routing decisions + execution:
- Analyzes input, creates commandData
- Direct execution —á–µ—Ä–µ–∑ handlers
- `routeAndProcess(input, applicationLoop)` –º–µ—Ç–æ–¥
- Unified flow –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –∫–æ–º–∞–Ω–¥

#### 2.3 –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ handlers:
- **SystemCommandHandler**: help, exit, provider, model, cmd
- **CommandHandler**: single instruction –∫–æ–º–∞–Ω–¥—ã —Å cache logic
- **ChatRequest**: final AI request processing —Å unified spinner

## üéõÔ∏è –ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã –∏ –º–æ–¥–µ–ª–∏

### –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤:
–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞–±–æ—Ç—É —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ AI –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ:
- **OpenAI** (GPT-4, GPT-3.5, gpt-5-mini)
- **DeepSeek** (deepseek-chat)
- **Anthropic** (Claude 3.5 Sonnet, Haiku, Opus)

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –ø—Ä–∏–Ω—Ü–∏–ø**: Legacy State –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å Modern ServiceManager –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ.

### –õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤:
- ‚úÖ **Instant switching** - –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ –∑–∞ ~0.016ms
- ‚úÖ **Lazy loading** - –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏
- ‚úÖ **provider: null** - –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ (–∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ)
- ‚úÖ **selectedProviderKey** - –æ—Å–Ω–æ–≤–Ω–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–æ–∫ –≤ AIProcessor
- ‚úÖ **Fallback —Å–∏—Å—Ç–µ–º–∞** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö API

### –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤:
1. **–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ** —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É `provider`
2. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ** –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö (403, region block)
3. **Fallback —Ü–µ–ø–æ—á–∫–∞**: openai ‚Üí anthropic ‚Üí deepseek

## üåê MCP (Model Context Protocol) –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ:
–°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –≤–≤–æ–¥ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ MCP –æ–±—Ä–∞–±–æ—Ç–∫–∏:
- **URL detection**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –≤–µ–±-—Å—Å—ã–ª–æ–∫
- **Search intent**: –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- **Routing**: –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–º—É MCP —Å–µ—Ä–≤–µ—Ä—É (fetch/web-search)

### –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ MCP —Å–µ—Ä–≤–µ—Ä—ã:
- **fetchMCPServer**: –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å –≤–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü
- **searchMCPServer**: –ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ DuckDuckGo API

## üéØ –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –≤—ã–≤–æ–¥–∞ (output-handler.js)

### Single Source of Truth –¥–ª—è –≤—Å–µ–≥–æ –≤—ã–≤–æ–¥–∞:
–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π `outputHandler` –≤–º–µ—Å—Ç–æ –ø—Ä—è–º—ã—Ö –≤—ã–∑–æ–≤–æ–≤ `console.log` –∏–ª–∏ `process.stdout.write`:

**–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã:**
- `write(text)` - –æ—Å–Ω–æ–≤–Ω–æ–π –≤—ã–≤–æ–¥ —Å –ø–µ—Ä–µ–≤–æ–¥–æ–º —Å—Ç—Ä–æ–∫–∏
- `writeStream(chunk)` - –ø–æ—Ç–æ–∫–æ–≤—ã–π –≤—ã–≤–æ–¥ –±–µ–∑ –ø–µ—Ä–µ–≤–æ–¥–∞ —Å—Ç—Ä–æ–∫–∏
- `writeSuccess(text)` - —É—Å–ø–µ—à–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–∑–µ–ª–µ–Ω—ã–π —Ü–≤–µ—Ç)
- `writeError(text)` - –æ—à–∏–±–∫–∏ (–∫—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç)
- `writeWarning(text)` - –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (–∂–µ–ª—Ç—ã–π —Ü–≤–µ—Ç)
- `writeInfo(text)` - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–≥–æ–ª—É–±–æ–π —Ü–≤–µ—Ç)
- `writeRaw(text)` - —Å—ã—Ä–æ–π –≤—ã–≤–æ–¥ –±–µ–∑ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- `clearLine()`, `hideCursor()`, `showCursor()` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–º

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:**
- ‚úÖ **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥** - –æ–±—ä–µ–∫—Ç —Å –º–µ—Ç–æ–¥–∞–º–∏ (–ù–ï –∫–ª–∞—Å—Å)
- ‚úÖ **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** - –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ –≤—Å–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏  
- ‚úÖ **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ** - –æ–¥–Ω–∞ —Ç–æ—á–∫–∞ –¥–ª—è –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤—ã–≤–æ–¥–∞
- ‚úÖ **–¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞** - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ü–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ config/color.js

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏:**
- **ApplicationLoop.exitApp()**: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç outputHandler –¥–ª—è graceful shutdown —Å–æ–æ–±—â–µ–Ω–∏–π
- **StreamHandler**: —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–µ–Ω –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è outputHandler –º–µ—Ç–æ–¥–æ–≤
- **HelpCommand**: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç outputHandler –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞ —Ç–∞–±–ª–∏—Ü
- **–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**: –∑–∞–º–µ–Ω–∏–ª–∏ –ø—Ä—è–º—ã–µ console.log –Ω–∞ outputHandler –º–µ—Ç–æ–¥—ã

### –ü—Ä–∏–Ω—Ü–∏–ø—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
```javascript
// ‚ùå –°—Ç–∞—Ä—ã–π –ø–æ–¥—Ö–æ–¥
console.log('message')
process.stdout.write('text')

// ‚úÖ –ù–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥ —á–µ—Ä–µ–∑ outputHandler
outputHandler.write('message')
outputHandler.writeSuccess('Operation completed')
outputHandler.writeError('Something went wrong')
```

## üéØ –°–∏—Å—Ç–µ–º–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –∏ –∏—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∞

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∫–æ–º–∞–Ω–¥:
–°–∏—Å—Ç–µ–º–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã (help, exit, provider, model, cmd) –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ Router ‚Üí SystemCommandHandler:

**–ü–æ—Ç–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã `help`:**
```
User: "help" ‚Üí ApplicationLoop.startMainLoop()
                    ‚Üì
            router.routeAndProcess("help", applicationLoop)
                    ‚Üì
            Router.detectCommandType() ‚Üí "system"
                    ‚Üì
            SystemCommandHandler.handle()
                    ‚Üì
            HelpCommand.execute()
                    ‚Üì
            –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤—ã–≤–æ–¥ —á–µ—Ä–µ–∑ outputHandler
```

**–ü–æ—Ç–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã `exit`:**
```
User: "exit" ‚Üí ApplicationLoop.startMainLoop()
                    ‚Üì
            router.routeAndProcess("exit", applicationLoop)
                    ‚Üì
            Router.detectCommandType() ‚Üí "system"
                    ‚Üì
            SystemCommandHandler.handle()
                    ‚Üì
            ExitCommand.execute(args, context)
                    ‚Üì
            context.applicationLoop.exitApp()
                    ‚Üì
            ApplicationLoop.exitApp() - graceful shutdown
```

### Graceful Shutdown Process (ApplicationLoop.exitApp):
**–§–∞–∑–∞ 1 - –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞:**
- `stopUserInput()` - –∑–∞–∫—Ä—ã–≤–∞–µ—Ç readline interface
- –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç `rl.question()` –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –≤—ã—Ö–æ–¥–∞ –∏–∑ main loop

**–§–∞–∑–∞ 2 - –û—Ç–º–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π:**
- `cancelActiveOperations()` - —ç–∫–æ–Ω–æ–º–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –∏ —Ä–µ—Å—É—Ä—Å–æ–≤:
  - –ê–±–æ—Ä—Ç–∏—Ä—É–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ LLM –∑–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ AbortController
  - –û—á–∏—â–∞–µ—Ç spinner —Ç–∞–π–º–µ—Ä—ã
  - –£–¥–∞–ª—è–µ—Ç keypress event listeners
  - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ cancelled AI request

**–§–∞–∑–∞ 3 - –§–∏–Ω–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞:**
- `finalCleanup()` - –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã:
  - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫—É—Ä—Å–æ—Ä —á–µ—Ä–µ–∑ outputHandler.showCursor()
  - –í—ã–≤–æ–¥–∏—Ç –ø—Ä–æ—â–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ outputHandler.writeSuccess('Goodbye!')
  - process.exit(0) —á–µ—Ä–µ–∑ 50ms –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞

**–ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ exit:**
- `isExiting` —Ñ–ª–∞–≥ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –≤—ã–∑–æ–≤—ã exitApp()
- SIGINT handler —Ç–∞–∫–∂–µ –≤—ã–∑—ã–≤–∞–µ—Ç exitApp() –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏

## üõ†Ô∏è –°–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤

### User-Friendly Error Handling:
–í–º–µ—Å—Ç–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö stack trace –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:

```
‚ùå Provider not working: deepseek
Would you like to switch to another provider? (y/n): 
```

### –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ:
–°–∏—Å—Ç–µ–º–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–ª–∞–≤–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞:

1. **–î–µ—Ç–µ–∫—Ü–∏—è –æ—à–∏–±–∫–∏**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–º
2. **User-friendly —Å–æ–æ–±—â–µ–Ω–∏–µ**: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–Ω—è—Ç–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
3. **–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –≤—ã–±–æ—Ä**: –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤—ã–±—Ä–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä
4. **–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ**: –ë—ã—Å—Ç—Ä–∞—è —Å–º–µ–Ω–∞ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–∏–∞–ª–æ–≥–∞
5. **–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã**: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ—Å–ª–µ —Å–º–µ–Ω—ã –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞

### –ü—Ä–∏–Ω—Ü–∏–ø—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫:
- ‚úÖ **–ù–∏–∫–∞–∫–∏—Ö –∫—Ä–∞—à–µ–π** - –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤—Å–µ–≥–¥–∞ –æ—Å—Ç–∞–µ—Ç—Å—è —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω—ã–º
- ‚úÖ **–ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è** - —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å–∫—Ä—ã—Ç–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ **–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ** - –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ —Ä–∞–±–æ—á–∏–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä
- ‚úÖ **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞** - –¥–∏–∞–ª–æ–≥ —Å AI –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ —Å–º–µ–Ω—ã –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
- ‚úÖ **Graceful degradation** - –µ—Å–ª–∏ –≤—Å–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç, —á–µ—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ

### –¢–∏–ø—ã –æ—à–∏–±–æ–∫ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤:
1. **–õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞** - –ø—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞)
2. **API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω** - —Å–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏, –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å–º–µ–Ω—ã)
3. **–ù–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á** - –ø—Ä–æ–±–ª–µ–º—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (—á–µ—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
4. **–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç** - rate limiting (–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ–¥–æ–∂–¥–∞—Ç—å –∏–ª–∏ —Å–º–µ–Ω–∏—Ç—å)

## üîß –ö–ª—é—á–µ–≤—ã–µ —É—Ç–∏–ª–∏—Ç—ã

### StreamProcessor:
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ—Ç–æ–∫–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Ä–∞–∑–Ω—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ—Ç–º–µ–Ω—ã (Escape key)
- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–≤–æ–¥–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

### –ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏—à:
–°–∏—Å—Ç–µ–º–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –æ—Ç–∑—ã–≤—á–∏–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏:
- **Escape key**: –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- **–°–æ—Å—Ç–æ—è–Ω–∏–µ Processing**: –æ—Ç–º–µ–Ω–∞ API –∑–∞–ø—Ä–æ—Å–æ–≤
- **–°–æ—Å—Ç–æ—è–Ω–∏–µ Typing**: –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ—Ç–æ–∫–æ–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞
- **Return to prompt**: –≤–æ–∑–≤—Ä–∞—Ç –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º—É –≤–≤–æ–¥—É

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—É—Å—Ç—ã–º –≤–≤–æ–¥–æ–º:
**–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞:**
- **–ü–µ—Ä–≤–æ–µ –ø—É—Å—Ç–æ–µ –Ω–∞–∂–∞—Ç–∏–µ Enter**: –æ—á–∏—â–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Ç–µ–∫—É—â–µ–≥–æ –¥–∏–∞–ª–æ–≥–∞ —Å AI
- **–í—Ç–æ—Ä–æ–µ –ø—É—Å—Ç–æ–µ –Ω–∞–∂–∞—Ç–∏–µ Enter**: –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–∞–µ—Ç —ç–∫—Ä–∞–Ω —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ –¥–ª—è "—á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞"
- –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –±—ã—Å—Ç—Ä–æ "–ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å" —Å–µ—Å—Å–∏—é –±–µ–∑ –≤—ã—Ö–æ–¥–∞ –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–π:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≤–µ—Ä—à–∏–ª –¥–∏–∞–ª–æ–≥ —Å AI
2. –ù–∞–∂–∏–º–∞–µ—Ç Enter –ø—Ä–∏ –ø—É—Å—Ç–æ–º –≤–≤–æ–¥–µ ‚Üí –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ—á–∏—â–µ–Ω, –º–æ–∂–Ω–æ –Ω–∞—á–∞—Ç—å –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥
3. –ï—Å–ª–∏ –Ω—É–∂–µ–Ω —á–∏—Å—Ç—ã–π —ç–∫—Ä–∞–Ω ‚Üí –µ—â–µ —Ä–∞–∑ Enter –ø—Ä–∏ –ø—É—Å—Ç–æ–º –≤–≤–æ–¥–µ ‚Üí —ç–∫—Ä–∞–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–µ–Ω

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å UX:**
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –ø–æ—Ç–æ–∫–µ readline (CLIManager) 
- –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø—É—Å—Ç–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º –≤–≤–æ–¥–µ
- –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–ª–∞–≤–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### –°–∏—Å—Ç–µ–º–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è:
- **Per-command control**: –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º —á–µ—Ä–µ–∑ `is_cached` –ø–æ–ª–µ
- **–ü–µ—Ä–µ–≤–æ–¥—ã**: –ø–æ –∫–ª—é—á—É –∑–∞–ø—Ä–æ—Å–∞ (–µ—Å–ª–∏ is_cached=true)
- **Multi-provider**: –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (–µ—Å–ª–∏ is_cached=true)  
- **–î–æ–∫—É–º–µ–Ω—Ç—ã**: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —Ñ–∞–π–ª—ã
- **TTL caching** —Å –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–æ–π (30 –¥–Ω–µ–π)
- **CommandEditor integration**: –≤–∫–ª—é—á–µ–Ω–∏–µ/–æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –∫–µ—à–∞ —á–µ—Ä–µ–∑ UI
- **Force override**: —Ñ–ª–∞–≥–∏ `-f` –∏–ª–∏ `--force` –æ–±—Ö–æ–¥—è—Ç –∫–µ—à –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫

### ‚ö†Ô∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º:

#### 1. –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ (–ò–°–ü–†–ê–í–õ–ï–ù–û):
**–ë–´–õ–û**: –õ–æ–≥–∏–∫–∞ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞–∑–±—Ä–æ—Å–∞–Ω–∞ –ø–æ 5 —Ñ–∞–π–ª–∞–º
**–°–¢–ê–õ–û**: –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π `CacheManager` –∫–∞–∫ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è –≤—Å–µ—Ö —Ä–µ—à–µ–Ω–∏–π –ø–æ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—é

#### 2. –î–æ—Å—Ç—É–ø –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ (–ö–†–ò–¢–ò–ß–ù–û):
**–ü–†–û–ë–õ–ï–ú–ê**: –ù–∞—Ä—É—à–µ–Ω–∏–µ Single Source of Truth –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ SQLite –ë–î –∫–æ–º–∞–Ω–¥:
- –ü—Ä—è–º—ã–µ –∏–º–ø–æ—Ä—Ç—ã `getCommandsFromDB()` —Ä–∞–∑–±—Ä–æ—Å–∞–Ω—ã –ø–æ –≤—Å–µ–º—É –∫–æ–¥—É
- –ö–∞–∂–¥—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ –ë–î 
- –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º –∫–æ–º–∞–Ω–¥
- –í –±—É–¥—É—â–µ–º —ç—Ç–æ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ –Ω–µ–∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–æ–º—É —Ä–æ—Å—Ç—É –≥–æ–≤–Ω–æ–∫–æ–¥–∞

**–ê–†–•–ò–¢–ï–ö–¢–£–†–ù–û–ï –ü–†–ê–í–ò–õ–û**: –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –µ–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –ë–î –∫–æ–º–∞–Ω–¥:
- `DatabaseCommandService` - –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å —Å –ø—Ä–∞–≤–æ–º –∏–º–ø–æ—Ä—Ç–∞ `database-manager.js`
- –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø–æ–ª—É—á–∞—é—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–æ–º–∞–Ω–¥–∞–º –ë–î —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ —ç—Ç–æ—Ç —Å–µ—Ä–≤–∏—Å
- Dependency injection –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ —Å–µ—Ä–≤–∏—Å–∞ –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- –ó–∞–ø—Ä–µ—Ç –ø—Ä—è–º—ã—Ö –∏–º–ø–æ—Ä—Ç–æ–≤ `getCommandsFromDB()` –≤–µ–∑–¥–µ –∫—Ä–æ–º–µ `DatabaseCommandService`

**–¶–ï–õ–¨**: –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—É—é –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—é –∏ –æ–±–µ—Å–ø–µ—á–∏—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–π –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º.

## üß© –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã

### 1. Dual Architecture (Legacy + Modern):
–°–æ—Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ä–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã —Å –Ω–æ–≤—ã–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏ –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞:
- **Legacy**: –ø—Ä—è–º–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å aiState –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
- **Modern**: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ ServiceManager –¥–ª—è –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

### 2. Command Pattern:
–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥ –ø–æ —Ç–∏–ø–∞–º –∏ –æ–±–ª–∞—Å—Ç—è–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏:
- **Core commands**: —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã (help, exit)
- **AI commands**: –∫–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏ –∏ –º–æ–¥–µ–ª—è–º–∏
- **Instruction commands**: –∫–æ–º–∞–Ω–¥—ã –∏–∑ SQLite –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### 3. Factory Pattern:
–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ —Å –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π.

### 4. Chain of Responsibility (EXPERIMENTAL):
–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏, –æ—Ç–∫–ª—é—á–µ–Ω–∞ –≤ –ø–æ–ª—å–∑—É production-ready RequestRouter.

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
- **bin/app.js**: –ì–ª–∞–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (1660 —Å—Ç—Ä–æ–∫) —Å –ø–æ–ª–Ω–æ–π –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–æ–π
- **core/Router.js**: –ß–∏—Å—Ç—ã–π —Ä–æ—É—Ç–µ—Ä –¥–ª—è routing decisions (–±—ã–ª–æ RequestRouter)
- **core/ChatRequest.js**: –§–∏–Ω–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ AI –∑–∞–ø—Ä–æ—Å–æ–≤ (–±—ã–ª–æ AIProcessor)
- **core/CommandHandler.js**: –û–±—Ä–∞–±–æ—Ç–∫–∞ single –∫–æ–º–∞–Ω–¥ —Å –∫–µ—à –ª–æ–≥–∏–∫–æ–π (–Ω–æ–≤—ã–π)
- **core/MultiCommandHandler.js**: –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è multi-model —Å leaderboard (–Ω–æ–≤—ã–π)
- **core/CacheHandler.js**: –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–µ—à —Å –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π (–Ω–æ–≤—ã–π)
- **utils/application.js**: –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å Application —Å –æ–±—â–µ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å—é
- **utils/command-manager.js**: –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥–∞–º–∏
- **utils/provider-factory.js**: –§–∞–±—Ä–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è AI –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
- **utils/stream-processor.js**: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ—Ç–æ–∫–æ–≤—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
- **utils/database-manager.js**: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ SQLite –±–∞–∑–æ–π –∫–æ–º–∞–Ω–¥
- **utils/command-editor.js**: –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –∫–æ–º–∞–Ω–¥
- **services/service-manager.js**: –°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è —Å–µ—Ä–≤–∏—Å-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- **services/input-processing-service.js**: –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –∏ —Ñ–ª–∞–≥–æ–≤
- **services/DatabaseCommandService.js**: Single Source of Truth –¥–ª—è –ë–î –∫–æ–º–∞–Ω–¥

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:
- **config/commands.db**: SQLite –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å –∫–æ–º–∞–Ω–¥–∞–º–∏
- **config/mcp-servers.json**: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è MCP —Å–µ—Ä–≤–µ—Ä–æ–≤
- **config/default_models.js**: –ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏ –¥–ª—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
- **config/constants.js**: –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ UI —Å–∏–º–≤–æ–ª—ã

## üöÄ –°–æ—Å—Ç–æ—è–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:
1. **SQLite –∫–æ–º–∞–Ω–¥—ã**: aa, cc, rr, hsk –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–∑ –ë–î
2. **Multi-provider –ø–æ–¥–¥–µ—Ä–∂–∫–∞**: OpenAI, DeepSeek, Anthropic —Å –ª–µ–Ω–∏–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–æ–π
3. **MCP –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –≤–µ–±-–∫–æ–Ω—Ç–µ–Ω—Ç–∞
4. **Streaming**: –ø–æ—Ç–æ–∫–æ–≤—ã–π –≤—ã–≤–æ–¥ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –æ—Ç–º–µ–Ω—ã
5. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ø–µ—Ä–µ–≤–æ–¥—ã –∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
6. **CommandEditor**: –ø–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–∞–º–∏
7. **Robust Error Handling**: user-friendly –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ –±–µ–∑ –∫—Ä–∞—à–µ–π
8. **Instant Provider Switching**: –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ (~0.016ms)
9. **Graceful Recovery**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å–º–µ–Ω—ã –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

### üîÑ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:
1. **Production Ready**: Router ‚Üí CommandHandler ‚Üí ChatRequest –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
2. **Handler Chain**: —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π, –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω
3. **Composition Pattern**: MultiCommandHandler –∏—Å–ø–æ–ª—å–∑—É–µ—Ç CommandHandler –∫–∞–∫ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–µ –±–ª–æ–∫–∏
4. **ServiceManager**: –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω
5. **Unified Handlers**: CacheHandler —Å –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π, —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ error –∏ spinner

### üéØ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥—É:
- **–§–∞–∑–∞ 1 –∑–∞–≤–µ—Ä—à–µ–Ω–∞**: –º–µ—Ä—Ç–≤—ã–π –∫–æ–¥ —É–¥–∞–ª–µ–Ω, —Ç–µ—Å—Ç—ã –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω—ã
- **–§–∞–∑–∞ 2 –≥–æ—Ç–æ–≤–∞**: –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏–∑—É—á–µ–Ω–∞, —Ç–æ—á–∫–∏ –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã
- **Core –ø–æ–Ω–∏–º–∞–Ω–∏–µ**: –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞

## üîç –ö–ª—é—á–µ–≤—ã–µ —Ç–æ—á–∫–∏ –¥–ª—è –§–∞–∑—ã 2

### ‚úÖ –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –†–ï–ê–õ–ò–ó–û–í–ê–ù–ê:
1. **ApplicationLoop ‚Üí Router flow** - –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
2. **Legacy processAIInput** - —É–¥–∞–ª–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é
3. **SystemCommandHandler** - —Å–æ–∑–¥–∞–Ω –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
4. **Unified ESC handling** - —á–µ—Ä–µ–∑ AbortController –≤–µ–∑–¥–µ
5. **Clean separation** - –∫–∞–∂–¥—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –∏–º–µ–µ—Ç –æ–¥–Ω—É –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:
- `core/ApplicationLoop.js` ‚Üê UI layer + main loop + ESC handling + graceful shutdown
  - Main loop: startMainLoop() with readline interface
  - ESC handling: handleEscapeKey() —á–µ—Ä–µ–∑ AbortController
  - Graceful exit: exitApp() —Å 3-—Ñ–∞–∑–Ω–æ–π –æ—á–∏—Å—Ç–∫–æ–π —Ä–µ—Å—É—Ä—Å–æ–≤
  - UI compatibility: writeOutput(), writeError(), writeWarning(), writeInfo()
- `core/output-handler.js` ‚Üê Single Source of Truth –¥–ª—è –≤—Å–µ–≥–æ –≤—ã–≤–æ–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- `core/Router.js` ‚Üê routing decisions + direct execution (enhanced)
- `core/SystemCommandHandler.js` ‚Üê system commands (help, exit, provider, model, cmd)
- `core/ChatRequest.js` ‚Üê —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ AI –∑–∞–ø—Ä–æ—Å–æ–≤ (–±—ã–ª–æ AIProcessor)
- `core/CommandHandler.js` ‚Üê single –∫–æ–º–∞–Ω–¥—ã —Å –∫–µ—à –ª–æ–≥–∏–∫–æ–π
- `core/MultiCommandHandler.js` ‚Üê multi-model –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è
- `core/CacheManager.js` ‚Üê —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–µ—à (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω getInstance)
- `core/StateManager.js` ‚Üê aiState + contextHistory

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ö–æ—Ä–æ—à–æ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∞ –¥–ª—è —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –±–ª–∞–≥–æ–¥–∞—Ä—è —á–µ—Ç–∫–æ–º—É —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—é –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –Ω–∞–ª–∏—á–∏—é —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤.